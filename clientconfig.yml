- name: Install consul agents/clients
  become: yes
  hosts: cc

  tasks:
  - name: Include vars of encryption_keygen into the 'keygen'
    include_vars:
     file: group_vars/encryption_keygen
     name: keygen

  - name: Include vars of agent_token into the 'agent_token'
    include_vars:
     file: "~/.agent_token"
     name: agenttoken

# Copy consul binary to clients/agents
  - name: Include task list in play only if the condition is true
    include: tasks/installconsul.yml

# Copy config.json template file to agents/clients
  - name: Copy config template
    template:
      src: templates/agent_config_acl.json.j2
      dest: "/etc/consul.d/config.json"
    notify: restart consul

# Copy the consul.service file to agents/clients
  - name: Copy consul.service
    copy:
     src: files/agent_consul.service
     dest: "/etc/systemd/system/consul.service"
    notify: restart consul

# Install autocomplete
  - name: Install autocomplete
    shell:
      cmd: "consul -autocomplete-install"

#Re start consul
  handlers:
  - name: restart consul
    service:
     name: consul
     state: restarted
     enabled: yes
